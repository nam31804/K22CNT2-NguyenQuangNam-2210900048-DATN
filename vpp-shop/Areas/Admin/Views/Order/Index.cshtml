@model List<vpp_shop.Models.Order>

@{
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

@Html.AntiForgeryToken()

<link rel="stylesheet" href="~/css/admin/admin-order.css" />

<!-- SEARCH + FILTER -->
<div class="d-flex flex-wrap gap-2 mb-3 align-items-center">

    <input type="text"
           id="orderSearch"
           class="form-control w-auto"
           placeholder="Tìm ID / tên / SĐT..."
           onkeyup="filterOrders()" />

    <button class="btn btn-outline-secondary btn-sm" onclick="setStatus('ALL')">Tất cả</button>
    <button class="btn btn-outline-warning btn-sm" onclick="setStatus('PENDING')">PENDING</button>
    <button class="btn btn-outline-primary btn-sm" onclick="setStatus('PAID')">PAID</button>
    <button class="btn btn-outline-info btn-sm" onclick="setStatus('SHIPPING')">SHIPPING</button>
    <button class="btn btn-outline-success btn-sm" onclick="setStatus('COMPLETED')">COMPLETED</button>
    <button class="btn btn-outline-danger btn-sm" onclick="setStatus('CANCELLED')">CANCELLED</button>

</div>

<h1 class="h3 mb-4 text-gray-800">Quản lý đơn hàng</h1>

<table class="table table-bordered align-middle">
    <thead class="table-light">
        <tr>
            <th>ID</th>
            <th>Khách hàng</th>
            <th class="text-end">Tổng tiền</th>
            <th class="text-center">Thanh toán</th>   @* ✅ MỚI *@
            <th class="text-center">Trạng thái</th>
            <th>Ngày tạo</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        @foreach (var o in Model)
        {
            <tr id="row-@o.Id"
                data-status="@o.Status"
                data-search="@($"{o.Id} {o.ShippingName} {o.ShippingPhone}")">

                <td>@o.Id</td>
                <td>@o.ShippingName</td>

                <td class="text-end fw-bold">
                    @o.TotalMoney.ToString("N0")
                </td>

                <!-- ✅ THANH TOÁN -->
                <td class="text-center">
                    <span class="payment-method @o.PaymentMethod?.ToLower()">
                        @o.PaymentMethod
                    </span>
                </td>

                <td class="text-center">
                    <span class="order-status @o.Status.ToLower()"
                          id="status-badge-@o.Id">
                        @o.Status
                    </span>
                </td>

                <td>@o.CreatedAt?.ToString("dd/MM/yyyy HH:mm")</td>

                <td>
                    <button class="btn btn-sm btn-primary"
                            data-bs-toggle="modal"
                            data-bs-target="#orderModal-@o.Id">
                        Xem
                    </button>
                </td>
            </tr>
        }
    </tbody>
</table>

<!-- ================= MODALS ================= -->
@foreach (var o in Model)
{
    <div class="modal fade" id="orderModal-@o.Id" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">Chi tiết đơn hàng #@o.Id</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">

                    <h6>Thông tin khách hàng</h6>
                    <p>
                        <strong>Tên:</strong> @o.ShippingName <br />
                        <strong>SĐT:</strong> @o.ShippingPhone <br />
                        <strong>Địa chỉ:</strong> @o.ShippingAddress <br />
                        <strong>Thanh toán:</strong> @o.PaymentMethod
                    </p>

                    @if (!string.IsNullOrWhiteSpace(o.Note))
                    {
                        <div class="order-note">
                            <strong>📝 Ghi chú khách hàng:</strong>
                            <div>@o.Note</div>
                        </div>
                    }

                    <hr />

                    <h6>Sản phẩm</h6>
                    <table class="table table-sm table-bordered align-middle">
                        <thead>
                            <tr>
                                <th>Ảnh</th>
                                <th>Tên</th>
                                <th>SL</th>
                                <th>Giá</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var i in o.OrderItems)
                            {
                                <tr>
                                    <td style="width:70px">
                                        <img src="~/images/products/@i.Product.Image"
                                             width="60" height="60"
                                             class="border rounded"
                                             style="object-fit:contain" />
                                    </td>
                                    <td>@i.Product.Name</td>
                                    <td>@i.Quantity</td>
                                    <td>@i.Price.ToString("N0")</td>
                                </tr>
                            }
                        </tbody>
                    </table>

                    <hr />

                    <div class="d-flex gap-2 align-items-center">
                        <select id="status-@o.Id"
                                class="form-select w-auto"
                                @(o.Status == "COMPLETED" || o.Status == "CANCELLED" ? "disabled" : "")>

                            <option value="PENDING" selected="@(o.Status == "PENDING")">PENDING</option>
                            <option value="PAID" selected="@(o.Status == "PAID")">PAID</option>
                            <option value="SHIPPING" selected="@(o.Status == "SHIPPING")">SHIPPING</option>
                            <option value="COMPLETED" selected="@(o.Status == "COMPLETED")">COMPLETED</option>
                            <option value="CANCELLED" selected="@(o.Status == "CANCELLED")">CANCELLED</option>

                        </select>


                        <button type="button"
                                class="btn btn-success"
                                id="btn-update-@o.Id"
                                onclick="updateStatus(@o.Id)">
                            Cập nhật
                        </button>
                    </div>

                    <button type="button"
                            class="btn btn-danger mt-3"
                            onclick="deleteOrder(@o.Id)">
                        🗑️ Xoá đơn hàng
                    </button>

                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>

            </div>
        </div>
    </div>
}

@section Scripts {
    <script src="~/js/admin/admin-order.js"></script>
}
