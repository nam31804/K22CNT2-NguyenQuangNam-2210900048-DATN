@model List<vpp_shop.Models.Order>

@{
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

@Html.AntiForgeryToken()

<!-- SEARCH + FILTER -->
<div class="d-flex flex-wrap gap-2 mb-3 align-items-center">

    <input type="text"
           id="orderSearch"
           class="form-control w-auto"
           placeholder="Tìm ID / tên / SĐT..."
           onkeyup="filterOrders()" />

    <button class="btn btn-outline-secondary btn-sm" onclick="setStatus('ALL')">Tất cả</button>
    <button class="btn btn-outline-warning btn-sm" onclick="setStatus('PENDING')">PENDING</button>
    <button class="btn btn-outline-primary btn-sm" onclick="setStatus('PAID')">PAID</button>
    <button class="btn btn-outline-info btn-sm" onclick="setStatus('SHIPPING')">SHIPPING</button>
    <button class="btn btn-outline-success btn-sm" onclick="setStatus('COMPLETED')">COMPLETED</button>
    <button class="btn btn-outline-danger btn-sm" onclick="setStatus('CANCELLED')">CANCELLED</button>

</div>

<h1 class="h3 mb-4 text-gray-800">Quản lý đơn hàng</h1>

<table class="table table-bordered align-middle">
    <thead class="table-light">
        <tr>
            <th>ID</th>
            <th>Khách hàng</th>
            <th>Tổng tiền</th>
            <th>Trạng thái</th>
            <th>Ngày tạo</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        @foreach (var o in Model)
        {
            <tr id="row-@o.Id"
                data-status="@o.Status"
                data-search="@($"{o.Id} {o.ShippingName} {o.ShippingPhone}")">

                <td>@o.Id</td>
                <td>@o.ShippingName</td>
                <td>@o.TotalMoney.ToString("N0")</td>
                <td>
                    <span class="badge bg-info"
                          id="status-badge-@o.Id">
                        @o.Status
                    </span>
                </td>
                <td>@o.CreatedAt?.ToString("dd/MM/yyyy HH:mm")</td>
                <td>
                    <button class="btn btn-sm btn-primary"
                            data-bs-toggle="modal"
                            data-bs-target="#orderModal-@o.Id">
                        Xem
                    </button>
                </td>
            </tr>
        }
    </tbody>
</table>

<!-- ================= MODALS ================= -->
@foreach (var o in Model)
{
    <div class="modal fade" id="orderModal-@o.Id" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">Chi tiết đơn hàng #@o.Id</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">

                    <h6>Thông tin khách hàng</h6>
                    <p>
                        <strong>Tên:</strong> @o.ShippingName <br />
                        <strong>SĐT:</strong> @o.ShippingPhone <br />
                        <strong>Địa chỉ:</strong> @o.ShippingAddress
                    </p>

                    <hr />

                    <h6>Sản phẩm</h6>
                    <table class="table table-sm table-bordered align-middle">
                        <thead>
                            <tr>
                                <th>Ảnh</th>
                                <th>Tên</th>
                                <th>SL</th>
                                <th>Giá</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var i in o.OrderItems)
                            {
                                <tr>
                                    <td style="width:70px">
                                        @if (!string.IsNullOrEmpty(i.Product.Image))
                                        {
                                            <img src="~/images/products/@i.Product.Image"
                                                 width="60" height="60"
                                                 class="border rounded"
                                                 style="object-fit:contain" />
                                        }
                                    </td>
                                    <td>@i.Product.Name</td>
                                    <td>@i.Quantity</td>
                                    <td>@i.Price.ToString("N0")</td>
                                </tr>
                            }
                        </tbody>
                    </table>

                    <hr />

                    <!-- UPDATE STATUS -->
                    <div class="d-flex gap-2 align-items-center">
                        <select id="status-@o.Id"
                                class="form-select w-auto"
                                @(o.Status == "COMPLETED" || o.Status == "CANCELLED" ? "disabled" : "")>
                            <option value="PENDING">PENDING</option>
                            <option value="PAID">PAID</option>
                            <option value="SHIPPING">SHIPPING</option>
                            <option value="COMPLETED">COMPLETED</option>
                            <option value="CANCELLED">CANCELLED</option>
                        </select>

                        <button type="button"
                                class="btn btn-success"
                                id="btn-update-@o.Id"
                                onclick="updateStatus(@o.Id)"
                                @(o.Status == "COMPLETED" || o.Status == "CANCELLED" ? "disabled" : "")>
                            Cập nhật
                        </button>
                    </div>

                    <button type="button"
                            class="btn btn-danger mt-3"
                            onclick="deleteOrder(@o.Id)">
                        🗑️ Xoá đơn hàng
                    </button>

                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>

            </div>
        </div>
    </div>
}

<script>
    let currentStatus = 'ALL';

    function getToken() {
        return document.querySelector('input[name="__RequestVerificationToken"]').value;
    }

    function setStatus(status) {
        currentStatus = status;
        filterOrders();
    }

    function filterOrders() {
        const keyword = document.getElementById('orderSearch').value.toLowerCase();
        const rows = document.querySelectorAll('tbody tr');

        rows.forEach(row => {
            const matchStatus =
                currentStatus === 'ALL' || row.dataset.status === currentStatus;

            const matchSearch =
                keyword === '' || row.dataset.search.toLowerCase().includes(keyword);

            row.style.display = (matchStatus && matchSearch) ? '' : 'none';
        });
    }

    function updateStatus(orderId) {
        const status = document.getElementById(`status-${orderId}`).value;
        const token  = getToken();

        fetch('/Admin/Order/UpdateStatus', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `id=${orderId}&status=${status}&__RequestVerificationToken=${token}`
        })
        .then(r => r.json())
        .then(d => {
            if (!d.success) return;

            document.getElementById(`status-badge-${orderId}`).innerText = d.status;

            // 🔥 CẬP NHẬT DATA-STATUS ĐỂ FILTER ĐÚNG
            document.getElementById(`row-${orderId}`).dataset.status = d.status;

            filterOrders();

            if (d.status === 'COMPLETED' || d.status === 'CANCELLED') {
                document.getElementById(`status-${orderId}`).disabled = true;
                document.getElementById(`btn-update-${orderId}`).disabled = true;
            }
        });
    }

    function deleteOrder(orderId) {
        if (!confirm('Xoá đơn hàng này?')) return;

        const token = getToken();

        fetch('/Admin/Order/Delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `id=${orderId}&__RequestVerificationToken=${token}`
        })
        .then(r => r.json())
        .then(d => {
            if (!d.success) return;

            const modalEl = document.getElementById(`orderModal-${orderId}`);
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();

            modalEl.addEventListener('hidden.bs.modal', () => {
                document.getElementById(`row-${orderId}`).remove();
                document.body.classList.remove('modal-open');
                document.querySelectorAll('.modal-backdrop').forEach(e => e.remove());
            }, { once: true });
        });
    }
</script>
